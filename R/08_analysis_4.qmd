---
title: "08_analysis_4"
format: html
editor: visual
---

TO BE DELETED

# Linear regression for genes associated with smoking

## Error bar plot and Vulcano plot (p-value)

#### Since no significant q-values were found in 07_analysis_3, we decided to look at significant p-values instead.

```{r}
library(tidyverse)
library(broom)
library(patchwork)

```

#### Creating a table with status, gene names and log2 expression levels

```{r}
#Transforming the data to a long format to prepare it for analysis
merged_clean_aug_long <- merged_clean_aug |> 
  select(status_num, starts_with("ilmn")) |>                      #Selecting relevant columns
  pivot_longer(cols = starts_with("ilmn"),                        #Specifying which columns to be pivot
               names_to = "gene",                                 #Making a new column to store the gene names
               values_to = "expr_level"                           #Making a new column to store the corresponding expression levels in
               ) |> 
  mutate(log2_expr = log2(expr_level))                            

merged_clean_aug_long <- merged_clean_aug_long |> 
  select(status_num,gene,log2_expr)

print(merged_clean_aug_long)



```

#### Creating a table with gene names and a data column containing status and log2 expression level for each gene

```{r}
merged_clean_aug_long_nested <- merged_clean_aug_long |> 
  group_by(gene) |> 
  nest() |>  
  ungroup()

merged_clean_aug_long_nested
```

```{r}
merged_clean_aug_long_nested |>
  filter(gene == "ilmn_1343291") |> 
  pull(data)
```

#### Creating a column with a model_object column

```{r}
merged_clean_aug_long_nested <- merged_clean_aug_long_nested |> 
  group_by(gene) |> 
  mutate(model_object = map(.x = data,
                   .f = ~lm(formula = log2_expr ~ status_num,
                            data = .x)))
merged_clean_aug_long_nested
```

```{r}
# Looking at one gene
merged_clean_aug_long_nested |>
  filter(gene == "ilmn_1343293") |> 
  pull(model_object) |> 
  pluck(1) |>
  tidy(conf.int = TRUE,
       conf.level = 0.95)
```

#### Creating a column with model_object_tidy

```{r}
merged_clean_aug_long_nested <- merged_clean_aug_long_nested |> 
  mutate(model_object_tidy = map(.x = model_object, #specifies that the function will be applied to the model_object column
                                 .f = ~tidy(x = .x, # The x argument refers to the current model object being processed from the model_object column
                                            conf.int = TRUE, #include confidence intervals 
                                            conf.level = 0.95)))
merged_clean_aug_long_nested
```

#### Unnest the model_object_tidy column

```{r}
merged_estimates <- merged_clean_aug_long_nested |> 
  unnest(model_object_tidy)

merged_estimates
```

#### Filter, Select, and Convert Data Types for Gene Expression Estimates

```{r}
merged_estimates <- merged_estimates |> 
  filter(term == "status_num") |> 
  select(gene, p.value, estimate, conf.low, conf.high) |> 
  ungroup()

cols_to_convert <- c("p.value", "estimate", "conf.low", "conf.high")
merged_estimates[cols_to_convert] <- lapply(merged_estimates[cols_to_convert],
                                            function(x) as.numeric(as.character(x)))

merged_estimates
```

#### Finding p-value and determining if the results are significant

```{r}
# Changed from looking at significant q-value in 07_analysis to looking at significant p-values
merged_estimates <- merged_estimates |> 
  mutate(q.value = p.adjust(p.value),
         is_significant = case_when(p.value <= 0.05 ~ "yes", # obs p-value
                                    p.value > 0.05 ~ "no"))

merged_estimates
```

#### Finding genes with a significant p-value (p\<0.05)

```{r}
merged_estimates |>
  filter(is_significant == "yes") |> 
  select(gene, p.value, q.value)
```

### Error bar plot for all genes with a significant p-value

```{r}
merged_estimates |> 
  filter(is_significant == "yes") |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbarh() +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1, size = 11),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 5),
        plot.caption = element_text(size = 7)) +
  labs(x = "Estimates (95%CIs)",
       y = "",
       title = "Genes Associated with Smoking",
       caption = "DOI: https://doi.org/10.1016/j.placenta.2009.12.016")
```

It is clear that all significant genes are divided into 3 clusters:

-   a ≈ 0.22

-   a ≈ 0.15

-   a ≈ -0.11

This can also be concluded when looking at the numeric values for estimates for all significant genes:

```{r}
merged_estimates |> 
  filter(is_significant == "yes")
```

Therefore, we selected three genes to represent the three different clusters. Next, we will plot the linear regressions for these genes.

### Linear regression for 3 genes

```{r}
# Looking at the linear regressions for three probe_IDs representing each of the 3 different estimated
lr_ilmn_1651278 <- merged_clean_aug_long |>
  filter(gene == "ilmn_1651278") |>  
  ggplot(aes(x = status_num, 
             y = log2_expr)) +
  geom_point(alpha = 0.6) +  
  geom_smooth(method = "lm", 
              se = TRUE, 
              color = "#63B8B8") +  
  theme_minimal(base_size = 12) +
  theme(plot.caption = element_text(size = 8)) +
  labs(x = "Status",
    y = "Log2 Expr. level",
    title = "Probe_ID: ilmn_1651278")

lr_ilmn_1651375 <- merged_clean_aug_long |>
  filter(gene == "ilmn_1651375") |>  
  ggplot(aes(x = status_num, 
             y = log2_expr)) +
  geom_point(alpha = 0.6) +  
  geom_smooth(method = "lm", 
              se = TRUE, 
              color = "#63B8B8") +  
  theme_minimal(base_size = 12) +
  theme(plot.caption = element_text(size = 8)) +
  labs(x = "Status",
    y = "Log2 Expr. level",
    title = "Probe_ID: ilmn_1651375")

lr_ilmn_1651767 <- merged_clean_aug_long |>
  filter(gene == "ilmn_1651767") |>  
  ggplot(aes(x = status_num, 
             y = log2_expr)) +
  geom_point(alpha = 0.6) +  
  geom_smooth(method = "lm", 
              se = TRUE, 
              color = "#63B8B8") +  
  theme_minimal(base_size = 12) +
  theme(plot.caption = element_text(size = 8)) +
 labs(x = "Status",
    y = "Log2 Expr. level",
    title = "Probe_ID: ilmn_1651767")

#linear_regression_plot <- lr_ilmn_1651278 / lr_ilmn_1651375 / lr_ilmn_1651767

linear_regression_plot <- lr_ilmn_1651278 / lr_ilmn_1651375 / lr_ilmn_1651767 + 
  plot_layout(guides = "collect", 
              heights = c(5, 5, 5),  # Adjust row heights
              design = "A
                          B
                          C") +    # Designates the layout for each plot
  plot_annotation(
    title = "Linear Regression of Gene Expression Levels",
    caption = "DOI: https://doi.org/10.1016/j.placenta.2009.12.016"
  )


linear_regression_plot

ggsave("../results/plots/linear_regression_plot.png", linear_regression_plot, height = 15, width = 8, units = "in")
```

### Error bar plot for three genes

```{r}
merged_estimates |> 
  filter(gene %in% c("ilmn_1651278", "ilmn_1651375", "ilmn_1651767")) |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbarh() +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1, size = 11),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 5),
        plot.caption = element_text(size = 7)) +
  labs(x = "Estimates (95%CIs)",
       y = "",
       title = "Genes Associated with Smoking",
       caption = "DOI: https://doi.org/10.1016/j.placenta.2009.12.016")
```

### Error bar plot for 30 random significant genes

```{r}
merged_estimates |> 
  filter(is_significant == "yes") |> 
  sample_n(30) |> 
  ggplot(aes(x = estimate,
             y = fct_reorder(gene, estimate),
             xmin = conf.low,
             xmax = conf.high)) +
  geom_vline(xintercept = 0) +
  geom_errorbarh() +
  geom_point() +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(hjust = 1, size = 11),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 5),
        plot.caption = element_text(size = 7)) +
  labs(x = "Estimates (95%CIs)",
       y = "",
       title = "Genes Associated with Smoking",
       caption = "DOI: https://doi.org/10.1016/j.placenta.2009.12.016")
```

### Vulcano plot - Plotting of genes which are significant/not significant

```{r}
library("ggrepel")
vulcano_plot <- merged_estimates |>
  mutate(lbl = case_when(
    is_significant == "yes" ~ gene,
    is_significant == "no" ~ "")) |> 
  ggplot(aes(x = estimate,
             y = -log10(p.value),
             colour = is_significant,
             label = lbl)) +
  geom_point(size = 1,
             alpha = 0.5) +
  geom_text_repel(size = 4,
                  max.overlaps = 20) +
  geom_hline(yintercept = 0) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 1),
    plot.subtitle = element_text(hjust = 1),
    legend.position = "none") +
  labs(
    x = "Estimates",
    y = "-log10(p)",
    title = "Volcano plot for down/up regulated genes with significance < 0.05",
    subtitle = "Genes highlighted in turquoise were significant after multiple testing correction",
    caption = "DOI: https://doi.org/10.1016/j.placenta.2009.12.016")

vulcano_plot
```
