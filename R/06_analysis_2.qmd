---
title: "06_analysis_2"
format: html
editor: visual
---

### Loading libraries

```{r}
library(broom)
```

```{r}
gene_cols <- grep("^ilmn",
                  names(merged_data),
                  value = TRUE)

merged_log2_fold <- merged_data |> 
  group_by(status) |> 
  summarise(across(all_of(gene_cols), mean, na.nr = TRUE)) |> 
  pivot_longer(cols = -status,
               names_to = "gene",
               values_to = "mean_expr") |> 
  pivot_wider(names_from = status, 
              values_from = mean_expr) |> 
  mutate(log2_fold_change = log2(`smoker` / `non-smoker`))


p_values <- merged_data |>
  pivot_longer(cols = all_of(gene_cols), names_to = "gene", values_to = "expression") |>
  group_by(gene) |> 
  summarise(p_value = t.test(expression ~ status)$p.value)

merged_log2_fold <- merged_log2_fold |> 
  left_join(p_values, by = "gene")

print(merged_log2_fold)

# Count how many p-values are under 0.05 and thereby significant different
significant_genes_count <- merged_log2_fold |>
  filter(p_value < 0.05) |>
  summarise(count = n())

print(significant_genes_count)
```

### Volcano plot of up- and downregulated genes in smokers

```{r}
# Categorize genes as upregulated or downregulated
merged_log2_fold <- merged_log2_fold |>
  mutate(Regulation = case_when(
    log2_fold_change > 0 ~ "Upregulated",
    log2_fold_change < 0 ~ "Downregulated"))

# Create a plot
ggplot(merged_log2_fold, aes(x = reorder(gene, log2_fold_change), y = log2_fold_change, fill = Regulation)) +
  geom_bar(stat = "identity", width = 0.8) + 
  coord_flip() +  # Flip coordinates for better readability
  scale_fill_manual(values = c("Upregulated" = "blue", "Downregulated" = "red", "Neutral" = "grey")) +
  labs(title = "Upregulated vs. Downregulated Genes in Smokers",
       x = "Genes",
       y = "Log2-Fold Change") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),  # Remove y-axis gene labels
        plot.title = element_text(hjust = 0.5))


```
